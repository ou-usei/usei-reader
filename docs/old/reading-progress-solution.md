# é˜…è¯»è¿›åº¦ä¿å­˜è§£å†³æ–¹æ¡ˆ

## é—®é¢˜èƒŒæ™¯

åœ¨epubé˜…è¯»å™¨åº”ç”¨ä¸­ï¼Œé‡åˆ°äº†è¿›åº¦ä¿å­˜ä¸ä¸€è‡´çš„é—®é¢˜ï¼š
- ç”¨æˆ·ä»ç¬¬10é¡µé˜…è¯»åˆ°ç¬¬13é¡µå¹¶é€€å‡º
- æ§åˆ¶å°æ˜¾ç¤ºä¿å­˜åˆ°ç¬¬13é¡µï¼Œæ•°æ®åº“ä¸­ä¹Ÿèƒ½çœ‹åˆ°
- ä½†é‡æ–°è¿›å…¥æ—¶å´ä»ç¬¬10é¡µå¼€å§‹é˜…è¯»

## é—®é¢˜æ ¹æº

### 1. å®æ—¶ä¿å­˜çš„å¤æ‚æ€§
- åŸæ–¹æ¡ˆä½¿ç”¨`relocated`äº‹ä»¶å®æ—¶ä¿å­˜è¿›åº¦
- epub.jsçš„`relocated`äº‹ä»¶æœ‰å»¶è¿Ÿå’Œæ—¶åºé—®é¢˜
- ç”¨æˆ·ç¿»é¡µæ—¶å¯èƒ½å…ˆè§¦å‘æ—§é¡µé¢çš„äº‹ä»¶ï¼Œå†è§¦å‘æ–°é¡µé¢çš„äº‹ä»¶
- debouncedä¿å­˜æœºåˆ¶æ— æ³•å®Œå…¨è§£å†³æ—¶åºæ··ä¹±

### 2. localStorageä¸æ•°æ®åº“çš„ç«æ€æ¡ä»¶
- å¤æ‚çš„ç¼“å­˜æ¯”è¾ƒé€»è¾‘ï¼ˆæ—¶é—´æˆ³å¯¹æ¯”ï¼‰
- ç½‘ç»œå»¶è¿Ÿå¯¼è‡´çš„æ•°æ®ä¸åŒæ­¥
- Dashboardé‡æ–°æ¸²æŸ“æ—¶çš„å¤šæ¬¡è¿›åº¦åŠ è½½è¦†ç›–äº†åˆšä¿å­˜çš„è¿›åº¦

### 3. epub.jså†…éƒ¨çŠ¶æ€ä¸åŒæ­¥
- `display(location)`åªæ”¹å˜è§†è§‰æ˜¾ç¤º
- epub.jså†…éƒ¨å¯¼èˆªçŠ¶æ€å¯èƒ½æ²¡æœ‰åŒæ­¥æ›´æ–°
- `currentLocation()`è¿”å›å†…éƒ¨çŠ¶æ€ï¼Œä¸æ˜¾ç¤ºä½ç½®ä¸ä¸€è‡´

## æœ€ç»ˆè§£å†³æ–¹æ¡ˆ

### æ ¸å¿ƒç†å¿µï¼šé€€å‡ºæ—¶åŒæ­¥ä¿å­˜
**å®Œå…¨æŠ›å¼ƒå®æ—¶ä¿å­˜çš„å¤æ‚é€»è¾‘ï¼Œé‡‡ç”¨"é€€å‡ºæ—¶åŒæ­¥ä¿å­˜"çš„å¯é æ–¹æ¡ˆã€‚**

### 1. ç§»é™¤æ‰€æœ‰å®æ—¶ä¿å­˜é€»è¾‘
```javascript
// åˆ é™¤çš„å†…å®¹ï¼š
- relocatedäº‹ä»¶çš„è‡ªåŠ¨ä¿å­˜
- debouncedä¿å­˜æœºåˆ¶  
- å¤æ‚çš„localStorageç¼“å­˜é€»è¾‘
- ZustandçŠ¶æ€ç®¡ç†
```

### 2. é€€å‡ºæ—¶åŒæ­¥ä¿å­˜
```javascript
// Reader.js - handleBackå‡½æ•°
const handleBack = async () => {
  if (!currentUser || !book) {
    onBack();
    return;
  }

  setIsSaving(true);
  setSaveError(null);

  try {
    // ä¼˜å…ˆä½¿ç”¨æœ€åå·²çŸ¥çš„å‡†ç¡®ä½ç½®ï¼ˆæ¥è‡ªrelocatedäº‹ä»¶ï¼‰
    let currentCfi = lastKnownLocation.current;
    
    // å¦‚æœæ²¡æœ‰ï¼Œåˆ™å°è¯•getCurrentLocation()
    if (!currentCfi) {
      currentCfi = getCurrentLocation();
    }
    
    if (currentCfi) {
      console.log(`ğŸ“– ä¿å­˜é€€å‡ºä½ç½®: ${currentCfi}`);
      
      // åŒæ­¥ä¿å­˜åˆ°æ•°æ®åº“
      const success = await saveProgressToDatabase(book.uuid, currentCfi, currentUser.username);
      
      if (success) {
        console.log('âœ… è¿›åº¦ä¿å­˜æˆåŠŸï¼Œå¯ä»¥é€€å‡º');
        onBack();
      } else {
        throw new Error('ä¿å­˜åˆ°æ•°æ®åº“å¤±è´¥');
      }
    } else {
      console.log('âš ï¸ æ— æ³•è·å–å½“å‰ä½ç½®ï¼Œç›´æ¥é€€å‡º');
      onBack();
    }
  } catch (error) {
    console.error('âŒ ä¿å­˜è¿›åº¦å¤±è´¥:', error);
    setSaveError('ä¿å­˜è¿›åº¦å¤±è´¥ï¼Œè¯·é‡è¯•');
  } finally {
    setIsSaving(false);
  }
};
```

### 3. ç®€åŒ–åŠ è½½é€»è¾‘
```javascript
// progressUtils.js - æ•°æ®åº“æ˜¯å”¯ä¸€æ•°æ®æº
export const getBestProgress = async (bookUuid, username) => {
  // ç›´æ¥ä»æ•°æ®åº“è·å–è¿›åº¦ï¼Œæ— ä»»ä½•ç¼“å­˜é€»è¾‘
  return await getProgressFromDatabase(bookUuid, username);
};
```

### 4. è§£å†³epub.jså†…éƒ¨çŠ¶æ€ä¸åŒæ­¥
```javascript
// æ–¹æ¡ˆ1ï¼šå¼ºåˆ¶åŒæ­¥å†…éƒ¨çŠ¶æ€
if (initialLocation) {
  setTimeout(async () => {
    try {
      await rendition.display(initialLocation);
      console.log('ğŸ”„ å†…éƒ¨çŠ¶æ€å·²åŒæ­¥');
    } catch (error) {
      console.error('åŒæ­¥å†…éƒ¨çŠ¶æ€å¤±è´¥:', error);
    }
  }, 100);
}

// æ–¹æ¡ˆ2ï¼šè·Ÿè¸ªæœ€åå·²çŸ¥çš„å‡†ç¡®ä½ç½®
const lastKnownLocation = useRef(null);

rendition.on('relocated', (locationData) => {
  // æ›´æ–°æœ€åå·²çŸ¥çš„å‡†ç¡®ä½ç½®
  lastKnownLocation.current = locationData.start.cfi;
  // ...å…¶ä»–é€»è¾‘
});
```

### 5. é¿å…Dashboardçš„ç«æ€æ¡ä»¶
```javascript
// App.js - é€€å‡ºæ—¶æš‚æ—¶è·³è¿‡Dashboardçš„è¿›åº¦åŠ è½½
const handleBackToDashboard = async () => {
  setSelectedBook(null);
  setView('dashboard');
  
  // æš‚æ—¶è·³è¿‡Dashboardçš„è¿›åº¦åŠ è½½ï¼Œé¿å…è¦†ç›–åˆšä¿å­˜çš„è¿›åº¦
  setSkipProgressLoad(true);
  
  // 1ç§’åæ¢å¤æ­£å¸¸çš„è¿›åº¦åŠ è½½
  setTimeout(() => {
    setSkipProgressLoad(false);
  }, 1000);
};
```

### 6. å¯é çš„é”™è¯¯å¤„ç†
```javascript
// ä¿å­˜å¤±è´¥æ—¶çš„UIåé¦ˆ
{saveError && (
  <div style={{ /* é”™è¯¯å¯¹è¯æ¡†æ ·å¼ */ }}>
    <p>{saveError}</p>
    <div>
      <button onClick={handleRetrySave}>é‡è¯•ä¿å­˜</button>
      <button onClick={() => {
        setSaveError(null);
        onBack(); // å¼ºåˆ¶é€€å‡ºï¼Œä¸ä¿å­˜
      }}>æ”¾å¼ƒä¿å­˜å¹¶é€€å‡º</button>
    </div>
  </div>
)}
```

## æ–‡ä»¶ç»“æ„

### æ ¸å¿ƒæ–‡ä»¶ä¿®æ”¹

1. **Reader.js** - ä¸»è¦ä¿®æ”¹
   - ç§»é™¤å®æ—¶ä¿å­˜é€»è¾‘
   - å®ç°é€€å‡ºæ—¶åŒæ­¥ä¿å­˜
   - è§£å†³epub.jså†…éƒ¨çŠ¶æ€åŒæ­¥é—®é¢˜

2. **progressUtils.js** - å¤§å¹…ç®€åŒ–
   - ç§»é™¤localStorageç¼“å­˜é€»è¾‘
   - æ•°æ®åº“æˆä¸ºå”¯ä¸€æ•°æ®æº
   - ç®€åŒ–APIæ¥å£

3. **Dashboard.js** - é˜²æ­¢ç«æ€æ¡ä»¶
   - æ·»åŠ skipProgressLoadå‚æ•°
   - é¿å…ä»Readerè¿”å›æ—¶çš„é‡å¤åŠ è½½

4. **App.js** - åè°ƒç»„ä»¶
   - ç®¡ç†skipProgressLoadçŠ¶æ€
   - å¤„ç†ç»„ä»¶é—´çš„å¯¼èˆª

## å®æ–½æ•ˆæœ

### é¢„æœŸè¡Œä¸º
1. **è¿›å…¥é˜…è¯»** â†’ ä»æ•°æ®åº“åŠ è½½ä¸Šæ¬¡ä½ç½®
2. **é˜…è¯»è¿‡ç¨‹** â†’ æ— ä»»ä½•è‡ªåŠ¨ä¿å­˜ï¼Œçº¯ç²¹çš„é˜…è¯»ä½“éªŒ
3. **ç‚¹å‡»é€€å‡º** â†’ è·å–å½“å‰å‡†ç¡®ä½ç½®ï¼ŒåŒæ­¥ä¿å­˜åˆ°æ•°æ®åº“
4. **ä¿å­˜ç»“æœ** â†’ æˆåŠŸåˆ™é€€å‡ºï¼›å¤±è´¥åˆ™æç¤ºé‡è¯•æˆ–å¼ºåˆ¶é€€å‡º

### è§£å†³çš„é—®é¢˜
âœ… **æ•°æ®ä¸€è‡´æ€§**: é€€å‡ºæ—¶åœ¨å“ªé‡Œï¼Œæ‰“å¼€æ—¶å°±åœ¨å“ªé‡Œ  
âœ… **æ—¶åºé—®é¢˜**: æ¶ˆé™¤æ‰€æœ‰ç«æ€æ¡ä»¶å’Œæ—¶åºæ··ä¹±  
âœ… **æ€§èƒ½ä¼˜åŒ–**: æ— ä¸å¿…è¦çš„å®æ—¶ä¿å­˜å’Œå¤æ‚çŠ¶æ€ç®¡ç†  
âœ… **ç”¨æˆ·ä½“éªŒ**: æ˜ç¡®çš„ä¿å­˜çŠ¶æ€åé¦ˆ  
âœ… **é”™è¯¯å¤„ç†**: å¯é çš„å¤±è´¥æ¢å¤æœºåˆ¶  

## è°ƒè¯•æ—¥å¿—

### æ­£å¸¸æµç¨‹æ—¥å¿—
```
ğŸ“– åŠ è½½è¿›åº¦: epubcfi(/6/12!/4/38/1:0)
ğŸ“– ä»ä½ç½®å¼€å§‹: epubcfi(/6/12!/4/38/1:0)
ğŸ“– é˜…è¯»å™¨å·²å°±ç»ª
ğŸ”„ å†…éƒ¨çŠ¶æ€å·²åŒæ­¥
ğŸ“ å½“å‰é˜…è¯»ä½ç½®: epubcfi(/6/12!/4/42/1:0)  // ç”¨æˆ·ç¿»é¡µ
ğŸ“– ä¿å­˜é€€å‡ºä½ç½®: epubcfi(/6/12!/4/42/1:0)
âœ… è¿›åº¦ä¿å­˜æˆåŠŸï¼Œå¯ä»¥é€€å‡º
```

### å…³é”®ç‚¹
- åªæœ‰ç”¨æˆ·çœŸå®ç¿»é¡µæ‰æ˜¾ç¤ºä½ç½®å˜åŒ–
- ä¿å­˜çš„ä½ç½®ä¸æœ€åé˜…è¯»ä½ç½®å®Œå…¨ä¸€è‡´
- ä¸‹æ¬¡å¯åŠ¨ä»ç›¸åŒä½ç½®å¼€å§‹

## æŠ€æœ¯è¦ç‚¹

### epub.jsç›¸å…³
1. **äº‹ä»¶å¤„ç†**: `relocated`äº‹ä»¶ç”¨äºUIæ›´æ–°ï¼Œä¸ç”¨äºä¿å­˜
2. **ä½ç½®è·å–**: ä¼˜å…ˆä½¿ç”¨`lastKnownLocation`ï¼Œfallbackåˆ°`currentLocation()`
3. **çŠ¶æ€åŒæ­¥**: åŒé‡`display()`è°ƒç”¨ç¡®ä¿å†…éƒ¨çŠ¶æ€åŒæ­¥

### Reactç›¸å…³
1. **çŠ¶æ€ç®¡ç†**: ç®€åŒ–çŠ¶æ€ï¼Œé¿å…å¤æ‚çš„ç¼“å­˜é€»è¾‘
2. **ç»„ä»¶åè°ƒ**: é€šè¿‡propsæ§åˆ¶ç»„ä»¶è¡Œä¸ºï¼Œé¿å…å‰¯ä½œç”¨
3. **ç”Ÿå‘½å‘¨æœŸ**: æ­£ç¡®çš„cleanupå’Œåˆå§‹åŒ–

### æ•°æ®åº“ç›¸å…³
1. **å•ä¸€æ•°æ®æº**: æ•°æ®åº“æ˜¯å”¯ä¸€çš„æƒå¨æ•°æ®æº
2. **åŒæ­¥æ“ä½œ**: ç­‰å¾…ä¿å­˜å®Œæˆå†å…è®¸é€€å‡º
3. **é”™è¯¯å¤„ç†**: æ˜ç¡®çš„å¤±è´¥åé¦ˆå’Œé‡è¯•æœºåˆ¶

## æœªæ¥ä¼˜åŒ–æ–¹å‘

1. **æ€§èƒ½ä¼˜åŒ–**: è€ƒè™‘åœ¨é•¿æ—¶é—´é˜…è¯»æ—¶çš„å®šæœŸè‡ªåŠ¨ä¿å­˜
2. **ç¦»çº¿æ”¯æŒ**: ç½‘ç»œæ–­å¼€æ—¶çš„æœ¬åœ°ä¿å­˜å’ŒåŒæ­¥æœºåˆ¶
3. **å¤šè®¾å¤‡åŒæ­¥**: è·¨è®¾å¤‡çš„è¿›åº¦åŒæ­¥ç­–ç•¥
4. **ç”¨æˆ·åå¥½**: å¯é…ç½®çš„ä¿å­˜ç­–ç•¥ï¼ˆè‡ªåŠ¨/æ‰‹åŠ¨ï¼‰

## æ€»ç»“

è¿™ä¸ªè§£å†³æ–¹æ¡ˆé€šè¿‡ç®€åŒ–æ¶æ„ã€æ˜ç¡®èŒè´£åˆ†å·¥ï¼Œä»æ ¹æœ¬ä¸Šè§£å†³äº†epubé˜…è¯»è¿›åº¦ä¿å­˜çš„ä¸€è‡´æ€§é—®é¢˜ã€‚æ ¸å¿ƒæ€æƒ³æ˜¯"é€€å‡ºæ—¶ä¿å­˜ï¼Œå¯åŠ¨æ—¶åŠ è½½"ï¼Œé¿å…äº†å¤æ‚çš„å®æ—¶åŒæ­¥é€»è¾‘å¸¦æ¥çš„å„ç§é—®é¢˜ã€‚

**å…³é”®æˆåŠŸå› ç´ :**
- **ç®€å•å¯é ** > å¤æ‚æ™ºèƒ½
- **æ•°æ®åº“æƒå¨** > å¤šæºåŒæ­¥
- **ç”¨æˆ·æ˜ç¡®æ“ä½œ** > è‡ªåŠ¨æ¨æµ‹
- **åŒæ­¥ç­‰å¾…** > å¼‚æ­¥å‡è®¾