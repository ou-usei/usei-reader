---
epic: "核心系统重构与现代化"
status: "Done"
version: 1.0
---

# Epic: 系统重构：支持家庭共享与未来拓展

## Epic Goal

通过优化技术栈与系统架构，将现有应用重构为一个健壮、可维护的平台。此举旨在保障当前多用户功能的稳定性，并为未来实现家庭成员间的笔记共享等高级功能奠定坚实的技术基础。

## Epic Description

### 1. 现有系统上下文 (修订版)

*   **当前相关功能:**
    *   用户可以上传 EPUB 格式的电子书。
    *   系统会自动保存并同步用户在不同设备上的阅读进度。
    *   用户可以创建、查看和删除文本高亮/笔记。
    *   应用支持多用户，但用户系统非常初级。
*   **相关技术栈:**
    *   **前端:** React, Tailwind CSS, epub.js
    *   **后端:** Node.js, Express
    *   **数据库:** Supabase (PostgreSQL)
    *   **文件存储:** S3 兼容的对象存储 (R2)
*   **集成点:**
    *   前端通过 REST API 与后端进行通信。
    *   后端与 Supabase (用于数据库) 和 S3/R2 对象存储服务集成。

### 2. 增强细节 (修订版)

*   **将要添加/变更的内容:**
    1.  **数据库与认证服务迁移:**
        *   搭建自托管的 PostgreSQL 数据库。
        *   将现有数据从 Supabase 迁移到新的 PostgreSQL 实例中。
        *   实现基于 JWT 的、完全自托管的安全认证机制。
    2.  **后端分层重构:** 将 `server/app.js` 中的逻辑拆分为独立的路由层、服务层和数据访问层。
    3.  **引入 ORM 与数据库迁移工具:** 在新的数据库之上，使用 Prisma 或类似的 ORM，并建立自动化的数据库迁移流程。
    4.  **建立测试策略:** 为后端 API 和关键前端组件编写自动化测试。
*   **如何集成:**
    *   新的分层架构将在后端项目内部实施，对前端的 API 接口保持向后兼容。
    *   新的认证系统将要求前端在登录后存储 JWT，并在请求头中携带它来访问受保护的资源。
*   **成功标准 (修订版):**
    *   应用的所有数据请求都指向自托管的 PostgreSQL 数据库，不再与 Supabase 有任何连接。
    *   用户可以通过新的自托管认证服务进行注册和登录。
    *   后端代码库被清晰地组织成 `routes`, `services`, `dal/models` 等目录。
    *   数据库操作全部通过 ORM 进行。
    *   项目包含一套可运行的自动化测试套件，代码覆盖率达到一个初始目标（例如 30%）。
    *   所有现有功能（上传、阅读、进度同步、高亮）在重构后正常工作。

### Stories

1.  **故事一: 数据库与认证服务迁移**
    *   **简介:** 部署一个新的 PostgreSQL 数据库。将所有数据从 Supabase 迁移出来，并实现一个全新的、基于 JWT 的自托管用户认证服务来替换对 Supabase Auth 的依赖。
2.  **故事二: 后端架构分层与 ORM 集成**
    *   **简介:** 在完成迁移的基础上，将后端代码重构为分层架构（路由、服务、数据访问）。同时，引入 Prisma 等 ORM 来管理与新数据库的交互。
3.  **故事三: 建立测试并集成前端**
    *   **简介:** 为重构后的后端 API 建立集成测试。更新前端应用以适配新的自托管认证流程，并为关键组件添加测试。

### 兼容性要求 (Compatibility Requirements)

*   `[x]` 在重构的过渡阶段，对前端暴露的 API 接口应保持最大程度的向后兼容，以减少前端的修改量。
*   `[x]` 新的数据库模式（Schema）必须能够完全容纳从 Supabase 迁移过来的所有现有数据。
*   `[x]` UI/UX 变更应保持最小化，重构主要集中在后端技术升级上。

### 风险缓解 (Risk Mitigation)

*   **主要风险:** 数据迁移过程中出现数据丢失或不一致。
*   **缓解措施:**
    1.  **编写迁移脚本:** 开发专门的脚本来从 Supabase 导出数据，并将其导入到新的 PostgreSQL 数据库中。
    2.  **数据验证:** 在迁移后，编写验证脚本或手动抽查，确保数据的完整性和一致性。
    3.  **分步进行:** 先在开发环境中进行多次迁移演练，确保流程万无一失后，再对生产数据进行操作。
*   **回滚计划 (Rollback Plan):** 在最终切换到自托管数据库之前，保持 Supabase 数据库的只读状态一段时间。如果新系统出现严重问题，可以将应用的数据库连接切回 Supabase，作为紧急回退方案。

### 完成定义 (Definition of Done)

*   `[x]` 所有三个故事都已完成，并且满足各自的验收标准。
*   `[x]` 应用完全运行在自托管的 PostgreSQL 数据库之上，与 Supabase 的所有连接都已移除。
*   `[x]` 现有的所有功能（上传、阅读、进度同步、高亮）都经过了回归测试，并能正常工作。
*   `[x]` 关键的 API 端点被自动化测试所覆盖。
*   `[x]` 项目的架构文档 (`brownfield-architecture.md`) 已更新，以反映新的架构和技术栈。
