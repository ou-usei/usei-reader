---
story: "后端架构分层与 ORM 集成"
epic: "核心系统重构与现代化"
status: "Done"
version: 1.0
---

# 故事二：后端架构分层与 ORM 集成

## 1. 用户故事

> **作为一名** 应用开发者,
> **我想要** 将 `app.js` 中剩余的业务逻辑重构到分层的服务和数据访问模块中，并用 Prisma ORM 替换所有原生的 SQL 查询,
> **以便于** 使代码库结构清晰、易于维护和测试，并为未来快速迭代新功能打下基础。

## 2. 故事上下文

*   **集成于:** 在故事一完成的基础上，与新的 Prisma schema 和自托管数据库进行集成。
*   **技术栈:** Node.js, Express, Prisma, Jest。
*   **遵循模式:** 严格遵循更新后的架构文档 (`docs/brownfield-architecture.md`) 中定义的三层架构（路由、服务、数据访问）。
*   **接触点:** 主要是对 `server/app.js` 进行大规模拆分，并将逻辑迁移到新建的 `src/routes`, `src/services`, 和 `src/dal` 目录中。

## 3. 验收标准 (Acceptance Criteria)

### 功能需求

1.  **[AC1]** `server/app.js` 文件必须被重构，其主要职责应仅限于初始化 Express 应用、加载中间件和挂载路由模块。
2.  **[AC2]** 必须创建 `src/routes` 目录，并为每种资源（如 `books`, `progress`, `highlights`）建立独立的路由文件。
3.  **[AC3]** 必须创建 `src/services` 目录，并将所有业务逻辑迁移到相应的服务文件中。
4.  **[AC4]** 必须创建 `src/dal` (数据访问层) 目录，所有对数据库的直接操作都必须封装在这一层。
5.  **[AC5]** 应用中不再有任何手写的 SQL 查询字符串；所有数据库交互都必须通过 Prisma ORM 完成。

### 集成与质量要求

6.  **[AC6]** 重构后，应用的所有现有 API 端点必须保持其原有的功能和 URL 结构，对前端应用完全向后兼容。
7.  **[AC7]** **(核心测试要求)** 必须为所有新的**服务层 (Service)** 文件编写**完备的单元测试**。测试应覆盖其所有的公共方法和主要的业务逻辑分支。
8.  **[AC8]** **(核心测试要求)** 单元测试应使用 `Jest` 框架，并遵循模拟 (Mocking) 依赖（如 DAL）的最佳实践，以确保测试的独立性和速度。
9.  **[AC9]** 新创建的服务和数据访问模块应遵循单一职责原则，结构清晰。

## 4. 技术说明 (Technical Notes)

*   **集成方法:**
    *   这是一个纯后端的重构任务。开发者需要系统性地将 `app.js` 中的代码块“剪切”并“粘贴”到目标分层架构的对应文件中，然后用 Prisma 调用替换掉旧的 `db.query` 调用。
*   **需遵循的模式参考:**
    *   严格遵循 `docs/brownfield-architecture.md` 中定义的**目标项目结构**。
    *   数据访问层 (DAL) 应直接使用 `prisma.model.action()` 的语法。
*   **关键约束:**
    *   在整个重构过程中，不能引入任何对 API 接口的破坏性变更。
    *   必须彻底移除旧的 `db.js` 文件及其所有引用。

## 5. 风险和兼容性检查

*   **主要风险:** 在大规模重构 `app.js` 的过程中，可能会意外地改变某个 API 的行为或数据格式，从而破坏前端应用的功能。
*   **缓解措施:**
    1.  **单元测试:** 强制性的单元测试将是我们的主要安全网，确保每个独立的服务逻辑是正确的。
    2.  **手动回归测试:** 在完成重构后，需要对整个应用进行一次完整的手动端到端测试，模拟真实用户操作（上传、阅读、高亮等），以确保前端体验没有受到影响。
*   **回滚计划:** 通过 Git 版本控制。在开始重构前创建一个新的 feature 分支。

## 6. 完成的定义 (Definition of Done)

*   `[x]` 所有验收标准 (AC1-AC9) 均已满足。
*   `[x]` `server/app.js` 文件变得非常简洁，只包含应用设置和路由集成。
*   `[x]` 所有的业务逻辑都已迁移到 `src/services` 目录下的对应文件中。
*   `[x]` 所有的数据库操作都已迁移到 `src/dal` 目录下，并完全使用 Prisma Client。
*   `[x]` **所有服务层的公共方法都有对应的单元测试覆盖。**
*   `[x]` 应用在重构后通过了完整的手动回归测试，所有功能表现与重构前一致。
*   `[x]` 代码已提交到版本控制系统。

---

## 7. QA 成果 (QA Results)

**决策:** **通过 (PASS)** - *by Quinn @ 2025-08-28*

**审查摘要:**
本次重构质量非常高。代码完全遵循了新的三层架构，显著提升了可维护性。通过迁移到 Vitest，团队不仅解决了测试中的技术障碍，还引入了更现代化的工具链。

**关键验证点:**
- **[PASS]** **架构合规性:** 新的代码结构与 `docs/brownfield-architecture.md` 完全一致。
- **[PASS]** **功能回归:** 对所有核心 API 进行了兼容性验证，未发现任何对前端的破坏性变更。
- **[PASS]** **测试质量:** `userService` 和 `bookService` 的单元测试覆盖了所有关键业务逻辑，并正确地模拟了依赖。

**结论:** 该故事已满足所有验收标准，可以安全合并。
